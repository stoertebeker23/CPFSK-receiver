#define DECIMATION 527
//#define DECODE_FREQ 3832/50

#include <complex.h>
#include <stdio.h>	// for printf
#include <math.h>	// for sin/cos
#include <stdlib.h>
#include <string.h>

#include <time.h>

#include "fir_filter_fl.h"
//#include "fir_filter_sc.h"
#include "FIR_poly_bandpass.h"
#include "FIR_highpass.h"
#include "processor.h"
#include "include/decode.h"
//#include "../c/include/decode.h"

#ifdef USE_MSVC_ANSI_C_SIM

#define COMBF "kammfilter.csv"
#define DEMOD "demodulator.csv"
#define HIGHP "hochpass.csv"
#define DECBP "dec_bandpass.csv"
#define EXEC_DATA "times.csv"
//#define TESTSIGNAL //
#define REALSIGNAL
struct timespec start, end;
long time_diff;
int exec_times[527];

#endif

short cntr = DECIMATION - 1;
short runs = 1;

//long int result = 0;
float result;
float hp_result = 0;
//short hp_result= 0;
short result_short = 0;
//short delayed_sample = 0;
float delayed_sample = 0;
short i = 0;
short correction = 0;
short cnt = 0;
short subcnt = 0;

complex Q_sig = 0;
complex I_sig = 0;
complex del_Q_sig = 0;
complex del_I_sig = 0;
float output_y = 0;

//short * bp_filter[] = {
float * bp_filter[] = {
	FIR_BANDPASS_1, FIR_BANDPASS_2, FIR_BANDPASS_3, FIR_BANDPASS_4, FIR_BANDPASS_5, FIR_BANDPASS_6, 
	FIR_BANDPASS_7, FIR_BANDPASS_8, FIR_BANDPASS_9, FIR_BANDPASS_10, FIR_BANDPASS_11, FIR_BANDPASS_12, 
	FIR_BANDPASS_13, FIR_BANDPASS_14, FIR_BANDPASS_15, FIR_BANDPASS_16, FIR_BANDPASS_17, FIR_BANDPASS_18, 
	FIR_BANDPASS_19, FIR_BANDPASS_20, FIR_BANDPASS_21, FIR_BANDPASS_22, FIR_BANDPASS_23, FIR_BANDPASS_24, 
	FIR_BANDPASS_25, FIR_BANDPASS_26, FIR_BANDPASS_27, FIR_BANDPASS_28, FIR_BANDPASS_29, FIR_BANDPASS_30, 
	FIR_BANDPASS_31, FIR_BANDPASS_32, FIR_BANDPASS_33, FIR_BANDPASS_34, FIR_BANDPASS_35, FIR_BANDPASS_36, 
	FIR_BANDPASS_37, FIR_BANDPASS_38, FIR_BANDPASS_39, FIR_BANDPASS_40, FIR_BANDPASS_41, FIR_BANDPASS_42, 
	FIR_BANDPASS_43, FIR_BANDPASS_44, FIR_BANDPASS_45, FIR_BANDPASS_46, FIR_BANDPASS_47, FIR_BANDPASS_48, 
	FIR_BANDPASS_49, FIR_BANDPASS_50, FIR_BANDPASS_51, FIR_BANDPASS_52, FIR_BANDPASS_53, FIR_BANDPASS_54, 
	FIR_BANDPASS_55, FIR_BANDPASS_56, FIR_BANDPASS_57, FIR_BANDPASS_58, FIR_BANDPASS_59, FIR_BANDPASS_60, 
	FIR_BANDPASS_61, FIR_BANDPASS_62, FIR_BANDPASS_63, FIR_BANDPASS_64, FIR_BANDPASS_65, FIR_BANDPASS_66, 
	FIR_BANDPASS_67, FIR_BANDPASS_68, FIR_BANDPASS_69, FIR_BANDPASS_70, FIR_BANDPASS_71, FIR_BANDPASS_72, 
	FIR_BANDPASS_73, FIR_BANDPASS_74, FIR_BANDPASS_75, FIR_BANDPASS_76, FIR_BANDPASS_77, FIR_BANDPASS_78, 
	FIR_BANDPASS_79, FIR_BANDPASS_80, FIR_BANDPASS_81, FIR_BANDPASS_82, FIR_BANDPASS_83, FIR_BANDPASS_84, 
	FIR_BANDPASS_85, FIR_BANDPASS_86, FIR_BANDPASS_87, FIR_BANDPASS_88, FIR_BANDPASS_89, FIR_BANDPASS_90, 
	FIR_BANDPASS_91, FIR_BANDPASS_92, FIR_BANDPASS_93, FIR_BANDPASS_94, FIR_BANDPASS_95, FIR_BANDPASS_96, 
	FIR_BANDPASS_97, FIR_BANDPASS_98, FIR_BANDPASS_99, FIR_BANDPASS_100, FIR_BANDPASS_101, FIR_BANDPASS_102, 
	FIR_BANDPASS_103, FIR_BANDPASS_104, FIR_BANDPASS_105, FIR_BANDPASS_106, FIR_BANDPASS_107, FIR_BANDPASS_108, 
	FIR_BANDPASS_109, FIR_BANDPASS_110, FIR_BANDPASS_111, FIR_BANDPASS_112, FIR_BANDPASS_113, FIR_BANDPASS_114, 
	FIR_BANDPASS_115, FIR_BANDPASS_116, FIR_BANDPASS_117, FIR_BANDPASS_118, FIR_BANDPASS_119, FIR_BANDPASS_120, 
	FIR_BANDPASS_121, FIR_BANDPASS_122, FIR_BANDPASS_123, FIR_BANDPASS_124, FIR_BANDPASS_125, FIR_BANDPASS_126, 
	FIR_BANDPASS_127, FIR_BANDPASS_128, FIR_BANDPASS_129, FIR_BANDPASS_130, FIR_BANDPASS_131, FIR_BANDPASS_132, 
	FIR_BANDPASS_133, FIR_BANDPASS_134, FIR_BANDPASS_135, FIR_BANDPASS_136, FIR_BANDPASS_137, FIR_BANDPASS_138, 
	FIR_BANDPASS_139, FIR_BANDPASS_140, FIR_BANDPASS_141, FIR_BANDPASS_142, FIR_BANDPASS_143, FIR_BANDPASS_144, 
	FIR_BANDPASS_145, FIR_BANDPASS_146, FIR_BANDPASS_147, FIR_BANDPASS_148, FIR_BANDPASS_149, FIR_BANDPASS_150, 
	FIR_BANDPASS_151, FIR_BANDPASS_152, FIR_BANDPASS_153, FIR_BANDPASS_154, FIR_BANDPASS_155, FIR_BANDPASS_156, 
	FIR_BANDPASS_157, FIR_BANDPASS_158, FIR_BANDPASS_159, FIR_BANDPASS_160, FIR_BANDPASS_161, FIR_BANDPASS_162, 
	FIR_BANDPASS_163, FIR_BANDPASS_164, FIR_BANDPASS_165, FIR_BANDPASS_166, FIR_BANDPASS_167, FIR_BANDPASS_168, 
	FIR_BANDPASS_169, FIR_BANDPASS_170, FIR_BANDPASS_171, FIR_BANDPASS_172, FIR_BANDPASS_173, FIR_BANDPASS_174, 
	FIR_BANDPASS_175, FIR_BANDPASS_176, FIR_BANDPASS_177, FIR_BANDPASS_178, FIR_BANDPASS_179, FIR_BANDPASS_180, 
	FIR_BANDPASS_181, FIR_BANDPASS_182, FIR_BANDPASS_183, FIR_BANDPASS_184, FIR_BANDPASS_185, FIR_BANDPASS_186, 
	FIR_BANDPASS_187, FIR_BANDPASS_188, FIR_BANDPASS_189, FIR_BANDPASS_190, FIR_BANDPASS_191, FIR_BANDPASS_192, 
	FIR_BANDPASS_193, FIR_BANDPASS_194, FIR_BANDPASS_195, FIR_BANDPASS_196, FIR_BANDPASS_197, FIR_BANDPASS_198, 
	FIR_BANDPASS_199, FIR_BANDPASS_200, FIR_BANDPASS_201, FIR_BANDPASS_202, FIR_BANDPASS_203, FIR_BANDPASS_204, 
	FIR_BANDPASS_205, FIR_BANDPASS_206, FIR_BANDPASS_207, FIR_BANDPASS_208, FIR_BANDPASS_209, FIR_BANDPASS_210, 
	FIR_BANDPASS_211, FIR_BANDPASS_212, FIR_BANDPASS_213, FIR_BANDPASS_214, FIR_BANDPASS_215, FIR_BANDPASS_216, 
	FIR_BANDPASS_217, FIR_BANDPASS_218, FIR_BANDPASS_219, FIR_BANDPASS_220, FIR_BANDPASS_221, FIR_BANDPASS_222, 
	FIR_BANDPASS_223, FIR_BANDPASS_224, FIR_BANDPASS_225, FIR_BANDPASS_226, FIR_BANDPASS_227, FIR_BANDPASS_228, 
	FIR_BANDPASS_229, FIR_BANDPASS_230, FIR_BANDPASS_231, FIR_BANDPASS_232, FIR_BANDPASS_233, FIR_BANDPASS_234, 
	FIR_BANDPASS_235, FIR_BANDPASS_236, FIR_BANDPASS_237, FIR_BANDPASS_238, FIR_BANDPASS_239, FIR_BANDPASS_240, 
	FIR_BANDPASS_241, FIR_BANDPASS_242, FIR_BANDPASS_243, FIR_BANDPASS_244, FIR_BANDPASS_245, FIR_BANDPASS_246, 
	FIR_BANDPASS_247, FIR_BANDPASS_248, FIR_BANDPASS_249, FIR_BANDPASS_250, FIR_BANDPASS_251, FIR_BANDPASS_252, 
	FIR_BANDPASS_253, FIR_BANDPASS_254, FIR_BANDPASS_255, FIR_BANDPASS_256, FIR_BANDPASS_257, FIR_BANDPASS_258, 
	FIR_BANDPASS_259, FIR_BANDPASS_260, FIR_BANDPASS_261, FIR_BANDPASS_262, FIR_BANDPASS_263, FIR_BANDPASS_264, 
	FIR_BANDPASS_265, FIR_BANDPASS_266, FIR_BANDPASS_267, FIR_BANDPASS_268, FIR_BANDPASS_269, FIR_BANDPASS_270, 
	FIR_BANDPASS_271, FIR_BANDPASS_272, FIR_BANDPASS_273, FIR_BANDPASS_274, FIR_BANDPASS_275, FIR_BANDPASS_276, 
	FIR_BANDPASS_277, FIR_BANDPASS_278, FIR_BANDPASS_279, FIR_BANDPASS_280, FIR_BANDPASS_281, FIR_BANDPASS_282, 
	FIR_BANDPASS_283, FIR_BANDPASS_284, FIR_BANDPASS_285, FIR_BANDPASS_286, FIR_BANDPASS_287, FIR_BANDPASS_288, 
	FIR_BANDPASS_289, FIR_BANDPASS_290, FIR_BANDPASS_291, FIR_BANDPASS_292, FIR_BANDPASS_293, FIR_BANDPASS_294, 
	FIR_BANDPASS_295, FIR_BANDPASS_296, FIR_BANDPASS_297, FIR_BANDPASS_298, FIR_BANDPASS_299, FIR_BANDPASS_300, 
	FIR_BANDPASS_301, FIR_BANDPASS_302, FIR_BANDPASS_303, FIR_BANDPASS_304, FIR_BANDPASS_305, FIR_BANDPASS_306, 
	FIR_BANDPASS_307, FIR_BANDPASS_308, FIR_BANDPASS_309, FIR_BANDPASS_310, FIR_BANDPASS_311, FIR_BANDPASS_312, 
	FIR_BANDPASS_313, FIR_BANDPASS_314, FIR_BANDPASS_315, FIR_BANDPASS_316, FIR_BANDPASS_317, FIR_BANDPASS_318, 
	FIR_BANDPASS_319, FIR_BANDPASS_320, FIR_BANDPASS_321, FIR_BANDPASS_322, FIR_BANDPASS_323, FIR_BANDPASS_324, 
	FIR_BANDPASS_325, FIR_BANDPASS_326, FIR_BANDPASS_327, FIR_BANDPASS_328, FIR_BANDPASS_329, FIR_BANDPASS_330, 
	FIR_BANDPASS_331, FIR_BANDPASS_332, FIR_BANDPASS_333, FIR_BANDPASS_334, FIR_BANDPASS_335, FIR_BANDPASS_336,
	FIR_BANDPASS_337, FIR_BANDPASS_338, FIR_BANDPASS_339, FIR_BANDPASS_340, FIR_BANDPASS_341, FIR_BANDPASS_342, 
	FIR_BANDPASS_343, FIR_BANDPASS_344, FIR_BANDPASS_345, FIR_BANDPASS_346, FIR_BANDPASS_347, FIR_BANDPASS_348, 
	FIR_BANDPASS_349, FIR_BANDPASS_350, FIR_BANDPASS_351, FIR_BANDPASS_352, FIR_BANDPASS_353, FIR_BANDPASS_354, 
	FIR_BANDPASS_355, FIR_BANDPASS_356, FIR_BANDPASS_357, FIR_BANDPASS_358, FIR_BANDPASS_359, FIR_BANDPASS_360, 
	FIR_BANDPASS_361, FIR_BANDPASS_362, FIR_BANDPASS_363, FIR_BANDPASS_364, FIR_BANDPASS_365, FIR_BANDPASS_366, 
	FIR_BANDPASS_367, FIR_BANDPASS_368, FIR_BANDPASS_369, FIR_BANDPASS_370, FIR_BANDPASS_371, FIR_BANDPASS_372, 
	FIR_BANDPASS_373, FIR_BANDPASS_374, FIR_BANDPASS_375, FIR_BANDPASS_376, FIR_BANDPASS_377, FIR_BANDPASS_378, 
	FIR_BANDPASS_379, FIR_BANDPASS_380, FIR_BANDPASS_381, FIR_BANDPASS_382, FIR_BANDPASS_383, FIR_BANDPASS_384, 
	FIR_BANDPASS_385, FIR_BANDPASS_386, FIR_BANDPASS_387, FIR_BANDPASS_388, FIR_BANDPASS_389, FIR_BANDPASS_390, 
	FIR_BANDPASS_391, FIR_BANDPASS_392, FIR_BANDPASS_393, FIR_BANDPASS_394, FIR_BANDPASS_395, FIR_BANDPASS_396, 
	FIR_BANDPASS_397, FIR_BANDPASS_398, FIR_BANDPASS_399, FIR_BANDPASS_400, FIR_BANDPASS_401, FIR_BANDPASS_402, 
	FIR_BANDPASS_403, FIR_BANDPASS_404, FIR_BANDPASS_405, FIR_BANDPASS_406, FIR_BANDPASS_407, FIR_BANDPASS_408, 
	FIR_BANDPASS_409, FIR_BANDPASS_410, FIR_BANDPASS_411, FIR_BANDPASS_412, FIR_BANDPASS_413, FIR_BANDPASS_414, 
	FIR_BANDPASS_415, FIR_BANDPASS_416, FIR_BANDPASS_417, FIR_BANDPASS_418, FIR_BANDPASS_419, FIR_BANDPASS_420, 
	FIR_BANDPASS_421, FIR_BANDPASS_422, FIR_BANDPASS_423, FIR_BANDPASS_424, FIR_BANDPASS_425, FIR_BANDPASS_426, 
	FIR_BANDPASS_427, FIR_BANDPASS_428, FIR_BANDPASS_429, FIR_BANDPASS_430, FIR_BANDPASS_431, FIR_BANDPASS_432, 
	FIR_BANDPASS_433, FIR_BANDPASS_434, FIR_BANDPASS_435, FIR_BANDPASS_436, FIR_BANDPASS_437, FIR_BANDPASS_438, 
	FIR_BANDPASS_439, FIR_BANDPASS_440, FIR_BANDPASS_441, FIR_BANDPASS_442, FIR_BANDPASS_443, FIR_BANDPASS_444, 
	FIR_BANDPASS_445, FIR_BANDPASS_446, FIR_BANDPASS_447, FIR_BANDPASS_448, FIR_BANDPASS_449, FIR_BANDPASS_450, 
	FIR_BANDPASS_451, FIR_BANDPASS_452, FIR_BANDPASS_453, FIR_BANDPASS_454, FIR_BANDPASS_455, FIR_BANDPASS_456, 
	FIR_BANDPASS_457, FIR_BANDPASS_458, FIR_BANDPASS_459, FIR_BANDPASS_460, FIR_BANDPASS_461, FIR_BANDPASS_462, 
	FIR_BANDPASS_463, FIR_BANDPASS_464, FIR_BANDPASS_465, FIR_BANDPASS_466, FIR_BANDPASS_467, FIR_BANDPASS_468, 
	FIR_BANDPASS_469, FIR_BANDPASS_470, FIR_BANDPASS_471, FIR_BANDPASS_472, FIR_BANDPASS_473, FIR_BANDPASS_474, 
	FIR_BANDPASS_475, FIR_BANDPASS_476, FIR_BANDPASS_477, FIR_BANDPASS_478, FIR_BANDPASS_479, FIR_BANDPASS_480, 
	FIR_BANDPASS_481, FIR_BANDPASS_482, FIR_BANDPASS_483, FIR_BANDPASS_484, FIR_BANDPASS_485, FIR_BANDPASS_486, 
	FIR_BANDPASS_487, FIR_BANDPASS_488, FIR_BANDPASS_489, FIR_BANDPASS_490, FIR_BANDPASS_491, FIR_BANDPASS_492, 
	FIR_BANDPASS_493, FIR_BANDPASS_494, FIR_BANDPASS_495, FIR_BANDPASS_496, FIR_BANDPASS_497, FIR_BANDPASS_498, 
	FIR_BANDPASS_499, FIR_BANDPASS_500, FIR_BANDPASS_501, FIR_BANDPASS_502, FIR_BANDPASS_503, FIR_BANDPASS_504, 
	FIR_BANDPASS_505, FIR_BANDPASS_506, FIR_BANDPASS_507, FIR_BANDPASS_508, FIR_BANDPASS_509, FIR_BANDPASS_510, 
	FIR_BANDPASS_511, FIR_BANDPASS_512, FIR_BANDPASS_513, FIR_BANDPASS_514, FIR_BANDPASS_515, FIR_BANDPASS_516, 
	FIR_BANDPASS_517, FIR_BANDPASS_518, FIR_BANDPASS_519, FIR_BANDPASS_520, FIR_BANDPASS_521, FIR_BANDPASS_522, 
	FIR_BANDPASS_523, FIR_BANDPASS_524, FIR_BANDPASS_525, FIR_BANDPASS_526, FIR_BANDPASS_527 }; 

float *delay_iter = NULL;
float delay_line[4];
float *rotating_rw = delay_line;

#ifdef USE_MSVC_ANSI_C_SIM

FILE *fid_OUT, *fid_OUT2, *fid_OUT1, *fid_OUT3, *EXEC_time_data;



void debug_init() {

    fid_OUT = fopen(COMBF, "w");
    fid_OUT1 = fopen(DEMOD, "w");
    fid_OUT2 = fopen(HIGHP, "w");
    fid_OUT3 = fopen(DECBP, "w");
    EXEC_time_data = fopen(EXEC_DATA, "w");
}

#endif
void process_comb_and_demod() {

	I_sig = hp_result + 0.17502 * delayed_sample;
	Q_sig = 0.9846  * I * delayed_sample;

	output_y = cimag(-(del_Q_sig * I_sig) + del_I_sig * Q_sig);



	del_Q_sig = Q_sig;
	del_I_sig = I_sig;
}
void output_sample() {
	// Short scaling
	//result_short = result >> 1;

    //printf("%d / %d\n", cnt, subcnt);
	// Highpass filter damping DC parts of the signal
	//hp_result = FIR_filter_sc(H_filt_remez_hp, FIR_highpass, N_delays_FIR_hp, result_short, 15);
	//hp_result = FIR_filter_fl(H_filt_remez_hp, FIR_highpass, N_delays_FIR_hp, result);
    hp_result = result;
	// Delayline counter overflow management
	if (rotating_rw == delay_line + 4)
		rotating_rw = delay_line;
	
	// Rotating delayed sample storage
	delayed_sample = *rotating_rw;
	*rotating_rw = hp_result;
	rotating_rw += 1;


#ifdef USE_MSVC_ANSI_C_SIM
	clock_gettime(CLOCK_MONOTONIC, &end);
#endif

#ifdef USE_MSVC_ANSI_C_SIM
	// Multiple debug infos
	fprintf(fid_OUT, "%f %fj\n", creal(I_sig), cimag(Q_sig));
	fprintf(fid_OUT1, "%f\n", creal(output_y));
	//fprintf(fid_OUT2, "%hd\n", hp_result);
	fprintf(fid_OUT2, "%f\n", hp_result);
	//fprintf(fid_OUT3, "%d\n", result_short);
	fprintf(fid_OUT3, "%f\n", result);
	//printf("%d", result_short);
#endif
    cnt++;

}

void process_sample(float value) {
#ifdef USE_MSVC_ANSI_C_SIM
	clock_gettime(CLOCK_MONOTONIC, &start);
#endif
	// Polyphase bandpass filtering
	result += FIR_filter_fl(H_filt_remez_dec[cntr], bp_filter[cntr], N_delays_FIR_poly, value);
	cntr -= 1;
	if (cntr < 0 ) {
		cntr = DECIMATION - 1;
		output_sample();
		result = 0;
		runs += 1;
	} else if (cntr == 250){

		process_comb_and_demod();
#ifdef USE_MSVC_ANSI_C_SIM
	clock_gettime(CLOCK_MONOTONIC, &end);
#endif
	} else if(cntr == 300) {
		// error every 66.6 seconds -> shit goes sideways after 41 Minutes for fixed window length
		// this means, that a normal bit will be interpreted as half a bit. This will mess up the start stop detection for at least one symbol
		if (cnt > 37 + correction){

			#ifdef TESTSIGNAL
	        	decode(output_y > 0);
	        #endif

	        #ifdef REALSIGNAL
	        	decode(output_y < 0);
	        #endif
	        // Correction as the symbol frequency is 38,31 hz
	        if ( subcnt == 2 ) {
	        	correction = 1;
	        	subcnt = 0;
	        } else {
	        	correction = 0;
	        	subcnt +=1;
	        }

	        cnt = 0;
	    }
#ifdef USE_MSVC_ANSI_C_SIM
	clock_gettime(CLOCK_MONOTONIC, &end);
#endif
	} else {
#ifdef USE_MSVC_ANSI_C_SIM
	clock_gettime(CLOCK_MONOTONIC, &end);
#endif
	}
#ifdef USE_MSVC_ANSI_C_SIM

	exec_times[cntr] = (int)(end.tv_nsec - start.tv_nsec + (runs - 1) * exec_times[cntr])/runs;
#endif
}

void publish_execution_time_data() {
	for (int j = 0; j < 527; j++) {
    	fprintf(EXEC_time_data, "%d\n", exec_times[j]);
    }
}